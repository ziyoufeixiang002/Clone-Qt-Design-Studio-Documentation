name: ðŸŽ¨ Clone Qt Design Studio Documentation (Robust)

on:
  workflow_dispatch:

jobs:
  clone-design-studio:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      TARGET_URL: "https://doc.qt.io/qtdesignstudio/"
      DOWNLOAD_DIR: "qtdesignstudio-docs"
    
    steps:
      - name: ðŸ› ï¸ Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd
          mkdir -p "$DOWNLOAD_DIR"
          echo "âœ“ Environment ready"

      - name: ðŸŒ Download with Anti-Bot Bypass
        run: |
          # å…³é”®ä¿®å¤ï¼š1) ç§»é™¤å±é™©å‚æ•° 2) å¢žå¼º User-Agent 3) æ·»åŠ  Referer 4) é‡è¯•æœºåˆ¶
          wget \
            --recursive \
            --level=inf \
            --page-requisites \
            --html-extension \
            --restrict-file-names=ascii \
            --domains=doc.qt.io \
            --no-parent \
            --wait=1.2 \
            --random-wait \
            --timeout=30 \
            --tries=5 \
            --waitretry=5 \
            --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --referer="https://doc.qt.io/" \
            --execute="robots=off" \          # å¿½ç•¥ robots.txt é™åˆ¶ï¼ˆä»…ç”¨äºŽæ–‡æ¡£ç«™ï¼Œåˆè§„å‰æä¸‹ï¼‰
            --accept-regex='\.((html?|css|js|qml|qmlproject|json|xml|md|txt|svg|png|jpg|jpeg|gif|ico|woff2?|ttf|otf)(\?.*)?$)' \
            --reject-regex='\.(mp[34]|avi|mov|wmv|flv|webm|wav|ogg|zip|rar|tar|gz|bz2|xz|7z|iso|dmg|exe|msi|apk|bin|deb|rpm|pdf|psd|ai|sketch|woff)$' \
            --directory-prefix="$DOWNLOAD_DIR" \
            "$TARGET_URL" 2>&1 | tee wget.log || echo "wget exited with code $?, continuing anyway..."
          
          # å…³é”®ï¼šå®¹å¿ wget é”™è¯¯ï¼Œä½†éªŒè¯æ ¸å¿ƒå†…å®¹æ˜¯å¦ä¸‹è½½
          core_files=$(find "$DOWNLOAD_DIR" -name "index.html" -o -name "quick-start.html" -o -name "*.qml" | wc -l)
          total_files=$(find "$DOWNLOAD_DIR" -type f | wc -l)
          
          echo "âœ“ Core files found: $core_files"
          echo "âœ“ Total files downloaded: $total_files"
          
          if [ "$core_files" -lt 3 ] || [ "$total_files" -lt 20 ]; then
            echo "âŒ Critical failure: Insufficient files downloaded"
            cat wget.log | grep -E "(ERROR|failed|403|404)" | head -20
            exit 1
          fi
        shell: bash {0}  # ç§»é™¤ -e é¿å…å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º

      - name: ðŸ” Diagnose Download Issues (if any)
        if: failure()
        run: |
          echo "=== wget error diagnostics ==="
          ls -R "$DOWNLOAD_DIR" 2>/dev/null | head -50
          grep -E "(ERROR|403|404)" wget.log 2>/dev/null || echo "No specific errors found"
          exit 1

      - name: ðŸ§¹ Cleanup & Fix Links
        run: |
          # 1. åˆ é™¤å¸¦æŸ¥è¯¢å‚æ•°çš„åžƒåœ¾æ–‡ä»¶
          find "$DOWNLOAD_DIR" -type f -name "*\?*" -delete 2>/dev/null || true
          
          # 2. ä¿®å¤ wget ç”Ÿæˆçš„ç•¸å½¢è·¯å¾„ï¼ˆdoc.qt.io åµŒå¥—é—®é¢˜ï¼‰
          if [ -d "$DOWNLOAD_DIR/doc.qt.io/qtdesignstudio" ]; then
            mv "$DOWNLOAD_DIR/doc.qt.io/qtdesignstudio"/* "$DOWNLOAD_DIR/" 2>/dev/null || true
            rm -rf "$DOWNLOAD_DIR/doc.qt.io"
          fi
          
          # 3. åˆ é™¤ç©ºç›®å½•
          find "$DOWNLOAD_DIR" -type d -empty -delete 2>/dev/null || true
          
          echo "âœ“ Cleanup completed"
          echo "ðŸ“ Final file count: $(find $DOWNLOAD_DIR -type f | wc -l)"

      - name: ðŸ“¦ Compress with Zstandard
        run: |
          if [ ! -d "$DOWNLOAD_DIR" ] || [ "$(find $DOWNLOAD_DIR -type f | wc -l)" -lt 10 ]; then
            echo "âŒ Download directory invalid or empty"
            exit 1
          fi
          
          zstd -T0 -19 -f -o qtdesignstudio-docs.zst "$DOWNLOAD_DIR"
          ls -lh qtdesignstudio-docs.zst
          echo "âœ“ Compression successful"

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: qtdesignstudio-offline-docs
          path: qtdesignstudio-docs.zst
          retention-days: 14

      - name: ðŸ—‘ï¸ Cleanup Workspace
        if: always()
        run: rm -rf "$DOWNLOAD_DIR" qtdesignstudio-docs.zst wget.log 2>/dev/null || true
