name: ğŸ¨ Clone Qt Design Studio Documentation

on:
  workflow_dispatch:

jobs:
  clone-design-studio:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      TARGET_URL: "https://doc.qt.io/qtdesignstudio/"
      DOWNLOAD_DIR: "qtdesignstudio-docs"
    
    steps:
      - name: ğŸ› ï¸ Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd
          mkdir -p $DOWNLOAD_DIR
          echo "âœ“ Created download directory: $DOWNLOAD_DIR"

      - name: ğŸŒ Download Documentation (Strict Filtering)
        run: |
          wget \
            --recursive \
            --page-requisites \
            --convert-links \
            --html-extension \
            --restrict-file-names=ascii \
            --domains doc.qt.io \
            --no-parent \
            --wait=0.7 \
            --random-wait \
            --timeout=25 \
            --tries=3 \
            --user-agent="Mozilla/5.0 (compatible; QtDocsBot/1.0; +https://github.com/YOUR-USERNAME/qt-docs-mirror)" \
            --accept-regex '\.(html?|css|js|qml|qmlproject|json|xml|md|txt|svg|png|jpg|jpeg|gif|ico|woff2?|ttf|otf)$' \
            --reject-regex '\.(mp[34]|avi|mov|wmv|flv|webm|wav|ogg|zip|rar|tar|gz|bz2|xz|7z|iso|dmg|exe|msi|apk|bin|deb|rpm|pdf|psd|ai|sketch)$' \
            --directory-prefix="$DOWNLOAD_DIR" \
            "$TARGET_URL"
          
          # éªŒè¯ä¸‹è½½ç»“æœ
          if [ ! -d "$DOWNLOAD_DIR/doc.qt.io/qtdesignstudio" ]; then
            echo "âŒ Download failed: Target directory not found"
            ls -lah "$DOWNLOAD_DIR" || echo "Download directory is empty"
            exit 1
          fi
          
          echo "âœ“ Download completed successfully"
          echo "ğŸ“ Total files downloaded: $(find $DOWNLOAD_DIR -type f | wc -l)"
        continue-on-error: false  # å¤±è´¥ç«‹å³åœæ­¢

      - name: ğŸ§¹ Cleanup Temporary Files
        run: |
          # Remove query-param files (e.g., style.css?12345)
          find "$DOWNLOAD_DIR" -type f -name "*\?*" -delete 2>/dev/null || true
          # Remove empty directories
          find "$DOWNLOAD_DIR" -type d -empty -delete 2>/dev/null || true
          echo "âœ“ Cleanup completed"

      - name: ğŸ“¦ Compress with Zstandard
        run: |
          # Verify directory exists before compressing
          if [ ! -d "$DOWNLOAD_DIR" ]; then
            echo "âŒ ERROR: Download directory missing!"
            exit 1
          fi
          
          zstd -T0 --long -19 -f -o qtdesignstudio-docs.zst "$DOWNLOAD_DIR"
          ls -lh qtdesignstudio-docs.zst
          echo "âœ“ Compression completed"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: qtdesignstudio-offline-docs
          path: qtdesignstudio-docs.zst
          retention-days: 14
          compression-level: 0

      - name: ğŸ—‘ï¸ Final Cleanup
        if: always()
        run: |
          rm -rf "$DOWNLOAD_DIR" qtdesignstudio-docs.zst
          echo "âœ“ Workspace cleaned"
